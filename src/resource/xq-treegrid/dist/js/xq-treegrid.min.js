/*!
 * xq-treegrid v1.0.4 (https://xqkeji.cn/demo/xq-treegrid/)
 * Author xqkeji.cn
 * LICENSE SSPL-1.0
 * Copyright 2023 xqkeji.cn
 */
 (function(){"use strict";const x=require("xq-util");const r=require("xq-confirm");const h=require("xq-html5sortable");const n={expanderTemplate:'<span class="xq-treegrid-expander"></span>',indentTemplate:'<span class="xq-treegrid-indent"></span>',indentClass:".xq-treegrid-indent",expanderClass:".xq-treegrid-expander",expanderExpandedClass:"xq-treegrid-expander-expanded",expanderCollapsedClass:"xq-treegrid-expander-collapsed",treeColumn:2,tableClass:".xq-treegrid",topClass:".xq-treegrid-top",dragClass:".xq-drag",checkAllClass:".xq-treegrid .xq-check-all",addBtnClass:".xq-treegrid .xq-add",editBtnClass:".xq-edit",deleteBtnClass:".xq-delete",copyBtnClass:".xq-copy",dragOffset:-30,"xq-url":null};let s={};const o=(t={})=>{s=Object.assign({},n);if(t){for(const e in t){if(Object.hasOwn(s,e)){s[e]=t[e]}}}};const y=t=>{if(t in s){return s[t]}const e=s["tableClass"];const n=document.querySelector(e);if(n.hasAttribute(t)){return String(n.getAttribute(t))}return""};let c;const m=()=>{if(c){return c}else{const t=y("tableClass");const e=document.querySelector(t);c=e;return c}};const l=()=>{const t=y("checkAllClass");const e=document.querySelector(t);if(e){e.addEventListener("click",t=>{const e=t.currentTarget;const{checked:n}=e;const s=m();const o=s?.querySelectorAll("tr > td:first-child > input[type=checkbox]");for(const c of o){if(c===e){continue}if(n){c.checked=true}else{c.checked=false}}})}};const i=t=>{if(t){const e=t.querySelector("tbody");if(e&&e.querySelectorAll("tr").length>1){const n=e.querySelector("tbody>tr:first-child");const s=n.getAttribute("id");const o=n.querySelector("td:first-child");o?.classList.add("xq-move");e.setAttribute("id","tbody_"+s);const c=e.querySelectorAll("tbody>tr:not(:first-child)");for(const r of c){const l=r.querySelector("td:first-child");l?.classList.add("xq-move");const i=document.createElement("tbody");i.append(r);const d=r.getAttribute("id");i.setAttribute("id","tbody_"+d);e.after(i)}}}};const d=()=>{const t=m();const e=y("topClass");const n=t.querySelectorAll("tbody>"+e);if(n){return n}return null};const a=()=>{const t=m();const e=y("topClass");const n=t.querySelector("tbody>"+e);if(n){return n.getAttribute("pid")}return null};const b=t=>{const e=t.getAttribute("id");if(e){return e}return""};const g=t=>{const e=m();if(!t.startsWith("xq_")){t="xq_"+t}return e.querySelector("#"+t)};const S=t=>{if(t.startsWith("xq_")){t=t.replace("xq_","")}const e=m();const n=e.querySelectorAll('tr[pid="'+t+'"]');return n};const q=t=>{const e=S(t);return e.length>0};const C=t=>{const e=t.getAttribute("pid");if(e){return g(e)}return null};const u=t=>{const e=t.getAttribute("pid");if(e){return e}return null};const A=t=>{const e=t.getAttribute("depth");if(e){return Number.parseInt(e,10)}return 0};const L=t=>{const e=t.getAttribute("is_leaf");return Number.parseInt(e,10)!==0};const v=t=>{const e=y("editBtnClass");const n=t.querySelector(e);if(n){n.addEventListener("click",t=>{const e=t.currentTarget;const n=x.parents(e,"tr")[0];const s=b(n);let o="";let c="";o=s.replace("xq_","");if(o){let t=e.getAttribute("xq-url");if(!t){t=window.location.href;if(t.includes(".html")||t.endsWith("/")){t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t=t+"/edit.html?id="+o}else{t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t=t+"/edit/"+o}}const r=n.querySelector("#name_"+o);c=r.getAttribute("value")+"设置";if(window.parent.window.xqAddTab!==void 0){window.parent.window.xqAddTab("treegrid-edit-"+o,c,t)}else{const l=document.querySelector("#xq-not-tab-url");if(l){l.setAttribute("action",t);l.submit()}else{const i='<form id="xq-not-tab-url" target="_blank" action="'+t+'" method="get"></form>';x.append(document.body,i);const d=document.querySelector("#xq-not-tab-url");d.submit()}}}})}};const _=c=>{const t=y("deleteBtnClass");const e=c.querySelector(t);if(e){e.addEventListener("click",()=>{let e="";if(L(c)){const t=y("xq-url");const n=b(c);const s=n.replace("xq_","");const o={id:s};if(!t){let t=window.location.href;t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t+="/delete";e=t}else{e=t+"/delete"}r({content:"确定要删除吗？",confirm(){fetch(e,{body:JSON.stringify(o),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{r({content:t.message,confirm(){if(t.code===200){P(c)}}})})}})}else{r({content:"存在子栏目无法进行删除操作！"})}})}};const E=t=>{const i=m();let d=t.getAttribute("id");d=d?.replace("xq_","");const e=t.querySelectorAll("input,select");for(const n of e){const s=n.getAttribute("id");if(s!=="id"&&s!=="check_all"){n.addEventListener("change",t=>{const e=t.currentTarget;let n=null;n=e.type==="checkbox"?e.checked:e.value;const s=e.getAttribute("id");const o=s?.slice(0,Math.max(0,s.indexOf("_")));const c=i?.getAttribute("pid");let r=y("xq-url");const l={id:d,field:o,value:n};if(!r){let t=window.location.href;if(c){t=t.replace("/"+c,"")}t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t+="/change";r=t}else{r+="/change"}fetch(r,{body:JSON.stringify(l),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{console.log(t)})})}}};const w=e=>{const t=y("copyBtnClass");const n=e.querySelector(t);if(n){n.addEventListener("click",()=>{let t=e.getAttribute("id");t=t.replace("xq_","");if(t){J(t);r({content:"已经将id复制到粘贴板"})}})}};const J=t=>{const e=document.createElement("input");e.setAttribute("value",t);document.body.append(e);e.select();document.execCommand("copy");e.remove()};const P=t=>{const e=y("treeColumn");const n=u(t);t.parentElement?.remove();if(n){const s=g(n);if(s&&!q(n)){s.setAttribute("is_leaf","1");const o=s.querySelector("td:nth-child("+e.toString()+")");const c=o.querySelectorAll("span");for(const r of c){r.remove()}j(s)}}};const W=t=>{const e=y("treeColumn");const n=y("expanderClass");const s=y("expanderCollapsedClass");const o=t.querySelector("td:nth-child("+e.toString()+")");if(o&&!L(t)){const c=o.querySelector(n);t.getAttribute("id");if(c.classList.contains(s)){return false}else{return true}}else{return true}};const O=(t,n=()=>{})=>{const e=y("treeColumn");const s=y("expanderClass");const o=y("expanderCollapsedClass");const c=y("expanderExpandedClass");const r=t.querySelector("td:nth-child("+e.toString()+")");if(r&&!L(t)){const l=r.querySelector(s);const i=t.getAttribute("id");if(l.classList.contains(o)){l.classList.remove(o);l.classList.add(c);if(!q(i)){let e=y("xq-url");if(!e){let t=window.location.href;t=t.slice(0,Math.max(0,t.lastIndexOf("/")));const d=i.replace("xq_","");t=t+"/subnode/"+d;e=t}else{const d=i.replace("xq_","");e=e+"/subnode/"+d}if(e.includes(":3000")){e=e.replace(":3000",":9000")}H(t,e,n);return}else{const a=S(i);for(const u of a){D(u)}}}else if(l.classList.contains(c)){l.classList.remove(c);l.classList.add(o);const a=S(i);for(const u of a){f(u)}}}n()};const H=(t,e,n=()=>{})=>{let s=t;const o=A(t);fetch(e).then(async t=>{return t.json()}).then(t=>{for(const e of t){e.depth=o+1;s=T(s,e)}n()})};const T=(t,e)=>{const n=m();const s=e.id;const o=e.pid;const c=e.is_leaf;const r=e.depth;const l=e.content;const i=document.createElement("tr");const d="xq_"+s;i.setAttribute("id","xq_"+s);i.setAttribute("pid",o);i.setAttribute("is_leaf",c);i.setAttribute("depth",r);i.innerHTML=l;j(i);E(i);_(i);v(i);w(i);const a=i.querySelector("td:first-child");a?.classList.add("xq-move");const u=document.createElement("tbody");u.setAttribute("id","tbody_"+d);u.append(i);if(t.tagName==="TABLE"){const p=n.querySelector("thead");p?.after(u)}else{t.parentElement?.after(u)}const f=y("dragClass");if(n.classList.contains(f.substring(1))){h(n,{})}return i};const D=t=>{if(t.classList.contains("d-none")){t.classList.remove("d-none")}};const f=t=>{const e=y("treeColumn");const n=y("expanderClass");const s=y("expanderCollapsedClass");const o=y("expanderExpandedClass");t.classList.add("d-none");const c=t.querySelector("td:first-child .form-check-input");if(c){c.checked=false}if(!L(t)){const r=S(b(t));const l=t.querySelector("td:nth-child("+e.toString()+")");if(l){const i=l.querySelector(n);i.classList.remove(o);i.classList.add(s)}for(const d of r){f(d)}}};const p=t=>{const e=C(t);const n=u(t).replace("xq_","");const s=A(e)+1;t.setAttribute("pid",n);t.setAttribute("depth",s.toString());j(t);if(!L(t)){const o=b(t);const c=S(o);if(c){F(c)}}};const F=t=>{for(const e of t){p(e)}};const R=t=>{const e=a().replace("xq_","");t.setAttribute("pid",e);t.setAttribute("depth","1");const n=y("topClass").slice(1);if(!t.classList.contains(n)){t.classList.add(n)}N(t)};const k=(t,e)=>{let n=null;const s=A(t);if(s>1){n=C(t)}const o=b(e).replace("xq_","");const c=A(e)+1;t.setAttribute("pid",o);t.setAttribute("depth",c.toString());const r=y("topClass").slice(1);if(t.classList.contains(r)){t.classList.remove(r)}if(L(e)){e.setAttribute("is_leaf","0")}N(e);const l=y("treeColumn");const i=y("expanderClass");const d=y("expanderCollapsedClass");const a=y("expanderExpandedClass");const u=e.querySelector("td:nth-child("+l.toString()+")");if(u&&!L(e)){const f=u.querySelector(i);if(f.classList.contains(d)){f.classList.remove(d);f.classList.add(a)}}N(t);if(n){const p=b(n);if(!q(p)){n.setAttribute("is_leaf","1")}N(n)}};const X=(t,e)=>{let n=null;const s=A(t);if(s>1){n=C(t)}const o=u(e).replace("xq_","");const c=A(e);t.setAttribute("pid",o);t.setAttribute("depth",c.toString());const r=y("topClass").slice(1);if(t.classList.contains(r)){t.classList.remove(r)}N(t);if(!L(e)){N(e)}if(n){const l=b(n);if(!q(l)){n.setAttribute("is_leaf","1")}N(n)}};const e=t=>{const e=y("treeColumn");const n=y("expanderTemplate");const s=y("expanderClass");const o=y("expanderCollapsedClass");const c=y("expanderExpandedClass");const r=t.querySelector("td:nth-child("+e.toString()+")");let l=o;if(r){const i=r.querySelector(s);if(i){if(i.classList.contains(c)){l=c}}const d=r.querySelectorAll("span");for(const a of d){a.remove()}x.prepend(r,n);if(!L(t)){const u=r.querySelector(s);if(u){u.classList.add(l);u.addEventListener("click",()=>{O(t)})}}}};const z=t=>{const e=y("treeColumn");const n=y("indentTemplate");const s=y("expanderClass");const o=t.querySelector(s);if(o){const c=t.querySelector("td:nth-child("+e.toString()+")");if(c){const r=A(t);for(let t=1;t<r;t++){x.prepend(c,n)}}}};const j=t=>{e(t);z(t)};const N=e=>{j(e);if(!L(e)){const n=b(e);const s=S(n);const o=e.parentElement;let t=o;for(const c of s){const r=c.parentElement;if(t!==r){t.after(r)}t=r;p(c);if(!L(c)){N(c)}}}};const G=()=>{const f=y("treeColumn");const p=y("expanderClass");const h=y("expanderCollapsedClass");const q=y("expanderExpandedClass");const t=y("addBtnClass");const e=document.querySelector(t);if(e){e.addEventListener("click",()=>{const n=m();const t=n.querySelectorAll("tbody > tr > td:first-child > input[type=checkbox]");const e=[];for(const o of t){if(o.checked){const c=x.parents(o,"tr")[0];const r=b(c);e.push(r)}}let s=y("xq-url");if(!s){let t=window.location.href;t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t+="/add";s=t}else{s+="/add"}if(e.length>0){for(const i of e){const l=g(i);const d=A(l);const a=i.replace("xq_","");const u={pid:a,depth:d};fetch(s,{body:JSON.stringify(u),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(n=>{const t=g(i);if(t){if(L(t)){const e=t.querySelector("td:nth-child("+f.toString()+")");const s=e.querySelectorAll("span");for(const c of s){c.remove()}t.setAttribute("is_leaf","0");j(t);const o=e.querySelector(p);if(o){o.classList.remove(h);o.classList.add(q)}T(t,n)}else{const e=t.querySelector("td:nth-child("+f.toString()+")");const o=e.querySelector(p);if(o.classList.contains(h)){O(t,()=>{const t=S(i);const e=t[t.length-1];T(e,n)})}else{const r=S(i);const l=r[r.length-1];T(l,n)}}}})}}else{const u={pid:""};fetch(s,{body:JSON.stringify(u),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{const e=n.querySelector("tbody:last-of-type>tr");if(e===null){T(n,t)}else{T(e,t)}})}})}};const K=()=>{const t=y("addBtnClass");const e=document.querySelector(t);if(e){if(typeof bootstrap!==void 0&&bootstrap.Tooltip!==void 0){new bootstrap.Tooltip(e)}}};const I=t=>{const e=t.previousElementSibling;const n=e.querySelector("tr");if(n){if(n.classList.contains("d-none")){return I(e)}return e}return null};const Q=(t,e)=>{const n=Number.parseInt(t.getAttribute("depth"),10);const s=t.parentElement;let o=s.nextElementSibling;let c=o.firstElementChild;let r=Number.parseInt(c.getAttribute("depth"),10);if(o.tagName=="TFOOT"){return null}while(o){if(r>n){return null}if(c.matches(e)){return c}o=o.nextElementSibling;c=o.firstElementChild;r=Number.parseInt(c.getAttribute("depth"),10)}return null};const U=t=>{const{item:e}=t.detail;const n=e.querySelector("tr");if(n&&!L(n)){const s=e.querySelector("tr");const o=S(b(s));for(const c of o){e.append(c)}}};const V=t=>{let{item:e}=t.detail;const n=e.querySelectorAll("tbody>tr:not(:first-child)");if(n){const t=m();for(const s of n){const o=s.getAttribute("id");const c="#tbody_"+o;const r=t.querySelector(c);if(r){e.after(r);e=r;r.append(s)}}}};const Y=t=>{const e=m();const{offsetLeft:n}=e;const s=t.detail;const o=s.item;const c=o.querySelector("td:first-child");const r=o.querySelector("tr");const{offsetWidth:l}=c;const i=s.dragEvent.pageX-n-l-10;const d=I(o);const a=d.querySelector("tr");if(d.tagName==="THEAD"){R(r);const u=B(r);M(u)}else if(i>0){if(W(a)){k(r,a);const u=B(r);M(u)}else{O(a,()=>{k(r,a);const t=B(r);M(t)})}}else{X(r,a);const u=B(r);M(u)}};const B=t=>{const e={id:"",pid:"",nextid:""};e.id=b(t).replace("xq_","");e.pid=u(t);const n=Q(t,'tr[pid="'+e.pid+'"]');if(n){e.nextid=b(n).replace("xq_","")}else{e.nextid=""}return e};const M=t=>{let e;const n=y("xq-url");if(!n){let t=window.location.href;t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t+="/move";e=t}else{e=n+"/move"}fetch(e,{body:JSON.stringify(t),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{console.log(t)})};const Z=()=>{const t=y("tableClass");const e=y("dragClass");const n=document.querySelector(t+e);if(n){h(n,{items:"tbody",handle:".xq-move",placeholder:'<tbody><tr><td colspan="99">&nbsp;</td></tr><tbody>'});n.addEventListener("sortstart",t=>{U(t)});n.addEventListener("sortstop",t=>{const e=t.detail.dragEvent;if(e.type==="dragend"){V(t);Y(t)}})}};const t=(t={})=>{o(t);const e=m();if(e){i(e);const n=d();if(n){for(const s of n){j(s);E(s);_(s);v(s);w(s)}}G();K();l();Z()}};x.domReady(()=>{t()});window.xqTreegrid=t;module.exports=t})();