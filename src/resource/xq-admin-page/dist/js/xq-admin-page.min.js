/*!
 * xq-admin-page v1.0.1 (https://xqkeji.cn/demo/xq-admin-page)
 * Author xqkeji.cn
 * LICENSE SSPL-1.0
 * Copyright 2023 xqkeji.cn
 */
 (function(){"use strict";const d=require("xq-util");const l=require("xq-confirm");const u=require("xq-html5sortable");const c={tableClass:".xq-table",dragClass:".xq-drag",checkAllClass:".xq-table .xq-check-all",addBtnClass:".xq-table .xq-add",editBtnClass:".xq-edit",deleteBtnClass:".xq-delete",copyBtnClass:".xq-copy",batchBtnClass:".xq-batch",backPageClass:".xq-backpage",authTableClass:".xq-auth-table",authCheckTableClass:".xq-auth-check-table",authCheckRowClass:".xq-auth-check-row",captchaClass:".xq-captcha"};let n={};const e=(t={})=>{n=Object.assign({},c);if(t){for(const e in t){if(Object.hasOwn(n,e)){treegridOptions[e]=t[e]}}}};const f=t=>{if(t in n){return n[t]}const e=n["tableClass"];const c=document.querySelector(e);if(c.hasAttribute(t)){return String(c.getAttribute(t))}return""};let o;const r=()=>{if(o){return o}else{const t=f("tableClass");const e=document.querySelector(t);o=e;return o}};const s=()=>{const t=f("addBtnClass");const e=document.querySelector(t);if(e){e.addEventListener("click",t=>{const e=t.currentTarget;const c=d.parents(e,"table")[0];const n=c.getAttribute("pid");let o=e.getAttribute("xq-url");if(!o){o=window.location.href;if(o.includes(".html")||o.includes("localhost")){o=o.slice(0,Math.max(0,o.lastIndexOf("/")));o+="/add.html"}else{if(n){o=o.replace("/"+n,"")}o=o.slice(0,Math.max(0,o.lastIndexOf("/")));o+=n?"/add/"+n:"/add"}}window.location.href=o})}};const i=s=>{const t=f("editBtnClass");const e=s.querySelector(t);if(e){e.addEventListener("click",t=>{const e=t.currentTarget;const c=r();const n=c?.getAttribute("pid");let o=s.getAttribute("id");o=o.replace("xq_","");if(o){let t=e.getAttribute("xq-url");if(!t){t=window.location.href;if(t.includes(".html")||t.endsWith("/")){t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t=t+"/edit.html?id="+o}else{if(n){t=t.replace("/"+n,"")}t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t=t+"/edit/"+o}}window.location.href=t}else{l({content:"找不到tr的id属性！"})}})}};const a=t=>{const e=document.createElement("input");e.setAttribute("value",t);document.body.append(e);e.select();document.execCommand("copy");e.remove()};const h=e=>{const t=f("copyBtnClass");const c=e.querySelector(t);if(c){c.addEventListener("click",()=>{let t=e.getAttribute("id");t=t.replace("xq_","");if(t){a(t);l({content:"已经将id复制到粘贴板"})}})}};const b=s=>{const t=f("deleteBtnClass");const e=s.querySelector(t);if(e){e.addEventListener("click",t=>{const e=t.currentTarget;const c=r();const n=c?.getAttribute("pid");let o=s.getAttribute("id");o=o.replace("xq_","");if(o){let t=e.getAttribute("xq-url");if(!t){t=window.location.href;if(n){t=t.replace("/"+n,"")}t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t+="/delete"}l({content:"确定要删除吗？",confirm(){fetch(t,{body:JSON.stringify({id:o}),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{l({content:t.message,confirm(){if(t.code===200){window.location.reload()}}})})}})}else{l({content:"找不到tr的id属性！"})}})}};const p=t=>{const l=r();let a=t.getAttribute("id");a=a?.replace("xq_","");const e=t.querySelectorAll("input,select");for(const c of e){const n=c.getAttribute("id");if(n!=="id"&&n!=="check_all"){c.addEventListener("change",t=>{const e=t.currentTarget;let c=null;c=e.type==="checkbox"?e.checked:e.value;const n=e.getAttribute("id");const o=n?.slice(0,Math.max(0,n.indexOf("_")));const s=l?.getAttribute("pid");let r=l?.getAttribute("xq-url");const i={id:a,field:o,value:c};if(!r){let t=window.location.href;if(s){t=t.replace("/"+s,"")}t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t+="/change";r=t}else{r+="/change"}fetch(r,{body:JSON.stringify(i),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{console.log(t)})})}}};const y=()=>{const t=f("batchBtnClass");const e=document.querySelectorAll(t);if(e){for(const c of e){c.addEventListener("click",t=>{const e=t.currentTarget;const c=d.parents(e,"table")[0];const n=c.getAttribute("pid");const o=d.parents(e,"form")[0];const s=e.getAttribute("name");if(s){let t=e.getAttribute("xq-url");if(!t){t=window.location.href;if(n){t=t.replace("/"+n,"")}t=t.slice(0,Math.max(0,t.lastIndexOf("/")));t=t+"/"+s}const r=d.jsonFormData(o);const i=JSON.stringify(r);if(i!=="{}"){l({content:"确定要进行批量操作吗？",confirm(){fetch(t,{body:i,headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{l({content:t.message,confirm(){if(t.code===200){window.location.reload()}}})})}})}else{l({content:"没有选择操作数据."})}}})}}};const q=()=>{const t=f("dragClass");const i=document.querySelector(t);if(i){const e=i.querySelector("tbody");if(e){const c=e.querySelector("tbody>tr:first-child");const n=c.getAttribute("id");const o=c.querySelector("td:first-child");o?.classList.add("xq-move");e.setAttribute("id","tbody_"+n);const s=e.querySelectorAll("tbody>tr:not(:first-child)");for(const r of s){const l=r.querySelector("td:first-child");l?.classList.add("xq-move");const a=document.createElement("tbody");a.append(r);const d=r.getAttribute("id");a.setAttribute("id","tbody_"+d);e.after(a)}}u(t,{items:"tbody",handle:".xq-move",placeholder:'<tbody><tr><td colspan="99">&nbsp;</td></tr><tbody>'});i.addEventListener("sortstop",()=>{const c=[];let n=0;const t=i.querySelectorAll("tbody");for(const s of t){n++;const t=s.querySelector("tr:first-child");const e=t?.getAttribute("id");const r={id:e,ordernum:n};c.push(r)}const e=i.getAttribute("pid");let o=i.getAttribute("xq-url");if(!o){o=window.location.href;if(e){o=o.replace("/"+e,"")}o=o.slice(0,Math.max(0,o.lastIndexOf("/")));o+="/b-order"}fetch(o,{body:JSON.stringify(c),headers:{"content-type":"application/json"},method:"POST"}).then(async t=>{return t.json()}).then(t=>{if(t.code===200);})})}};const g=()=>{const t=f("checkAllClass");const e=document.querySelector(t);if(e){e.addEventListener("click",t=>{const e=t.currentTarget;const{checked:c}=e;const n=r();const o=n?.querySelectorAll("tr > td:first-child > input[type=checkbox]");for(const s of o){if(s===e){continue}if(c){s.checked=true}else{s.checked=false}}})}};const m=()=>{let t;let e;let c;const n=f("backPageClass");const o=document.querySelectorAll(n);if(o){t=document.referrer;c=null;if(window.top!==window){try{c=window.top?.location.href}catch(t){}}if(t&&t!==document.location.href&&t!==c){sessionStorage.setItem(document.location.href,t);e=t}else{const s=sessionStorage.getItem(document.location.href);if(s){e=s.toString()}}for(const r of o){r.addEventListener("click",t=>{t.preventDefault();if(e){document.location.href=e}else{l({content:"系统无法自动返回上一个页面."})}})}}};const x=()=>{const t=f("authTableClass");const e=document.querySelectorAll(t);if(e){for(const s of e){const r=f("authCheckTableClass");const c=s.querySelector(r);if(c){const i=c.querySelector("input[type=checkbox]");if(i){i.addEventListener("click",t=>{const e=t.currentTarget;const{checked:c}=e;const n=s.querySelectorAll("input[type=checkbox]:not("+r+">input[type=checkbox])");for(const o of n){if(c){o.checked=true}else{o.checked=false}}})}}const n=f("authCheckRowClass");const o=s.querySelectorAll(n);for(const l of o){const a=l.querySelector("input[type=checkbox]");if(a){a.addEventListener("click",t=>{const e=t.currentTarget;const{checked:c}=e;const n=d.next(l,"td")[0];const o=n.querySelectorAll("input[type=checkbox]");for(const s of o){if(c){s.checked=true}else{s.checked=false}}})}}}}};const A=()=>{const e=document.querySelectorAll(".xq-fileinput");if(e&&typeof jQuery!==void 0){let t;for(const c of e){t=c.hasAttribute("xq-config")?c.getAttribute("xq-config"):"{}";$(c).fileinput(JSON.parse(t)).on("filedeleted",t=>{const e=t.currentTarget;S(e)}).on("fileuploaded",t=>{const e=t.currentTarget;S(e)}).on("filesorted",t=>{const e=t.currentTarget;S(e)});S(c)}}};const S=t=>{const e=t.getAttribute("id");const c=e.replace("-xq-fileinput","");const n=document.querySelector("#"+c);const o=$(t).fileinput("getPreview");n?.setAttribute("value",JSON.stringify(o));const s=$(t).fileinput("getFilesCount",true);const r=t.getAttribute("xq-config");const i=JSON.parse(r);if(i!==null&&"required"in i){if(s>0){t.removeAttribute("required")}else{t.setAttribute("required","true")}if("content"in o){const{content:l}=o;if(l.length===0){t.setCustomValidity("需要至少上传一个文件")}else{t.setCustomValidity("")}}}};const k=()=>{const t=f("captchaClass");const e=document.querySelector(t);if(e){e.addEventListener("click",t=>{const e=t.currentTarget;let c=e.getAttribute("src");if(c.includes("?")){c=c.slice(0,Math.max(0,c.lastIndexOf("?")));c=c+"?xq-r="+Math.random().toString()}else{c=c+"?xq-r="+Math.random().toString()}e.setAttribute("src",c)})}};const C=()=>{const t=r();if(t){const e=t.querySelectorAll("tr");for(const c of e){i(c);b(c);p(c);h(c)}g();s();y();q()}m();x();A();k()};const t=(t={})=>{e(t);C()};d.domReady(()=>{t()})})();